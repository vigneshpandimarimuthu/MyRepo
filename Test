WITH TEST_DATA as (
SELECT 1005 C1, 'April' C3, 2014 C5 from Dual
UNION ALL
SELECT 1093 C1, 'August' C3, 2014 C5 from Dual
UNION ALL
SELECT 679 C1, 'December' C3, 2014 C5 from Dual
UNION ALL
SELECT 714 C1, 'December' C3, 2015 C5 from Dual
UNION ALL
SELECT 951 C1, 'February' C3, 2014 C5 from Dual
UNION ALL
SELECT 1127 C1, 'January' C3, 2014 C5 from Dual
UNION ALL
SELECT 1191 C1, 'January' C3, 2015 C5 from Dual
UNION ALL
SELECT 906 C1, 'July' C3, 2014 C5 from Dual
UNION ALL
SELECT 835 C1, 'June' C3, 2014 C5 from Dual
UNION ALL
SELECT 1161 C1, 'March' C3, 2014 C5 from Dual
UNION ALL
SELECT 1093 C1, 'May' C3, 2014 C5 from Dual
UNION ALL
SELECT 1017 C1, 'November' C3, 2015 C5 from Dual
UNION ALL
SELECT 964 C1, 'October' C3, 2015 C5 from Dual
UNION ALL
SELECT 940 C1, 'September' C3, 2014 C5 from Dual
),
Month_data as
(SELECT 'January' MONTH_name, 1 Order_Month FROM DUAL UNION ALL
SELECT 'February', 2 FROM DUAL UNION ALL
SELECT 'March', 3 FROM DUAL UNION ALL
SELECT 'April', 4 FROM DUAL UNION ALL
SELECT 'May', 5 FROM DUAL UNION ALL
SELECT 'June', 6 FROM DUAL UNION ALL
SELECT 'July', 7 FROM DUAL UNION ALL
SELECT 'August', 8 FROM DUAL UNION ALL
SELECT 'September', 9 FROM DUAL UNION ALL
SELECT 'October', 10 FROM DUAL UNION ALL
SELECT 'November', 11 FROM DUAL UNION ALL
SELECT 'December', 12 FROM DUAL)
,DERIVED_TAB AS (
SELECT C1, C3, C5, CASE WHEN order_month<=ORDER_MON then C5 else c5-1 end as derived_year, month_name, order_month, ORDER_MON
from (
SELECT TEST_DATA.*, MONTH_DATA.*, mon_order.order_month order_mon  FROM Test_DATA, month_data, month_data mon_order
Where mon_order.month_name = test_data.c3
))
--SELECT * FROM DERIVED_TAB

SELECT SUM(C1), AGG2 TABLE_MONTH, AGG3 TABLE_YEAR, MONTH_NAME, AGG2||MONTH_NAME, CASE WHEN MAX(FLAG) = 'Y' THEN 12 ELSE COUNT(C3) END COUNTS, SUM(C1)/CASE WHEN MAX(FLAG) = 'Y' THEN 12 ELSE COUNT(C3) END AVERAGE
FROM (
SELECT Test_DATA.*, DERIVED_TAB.C1 AGG1, DERIVED_TAB.C3 AGG2, DERIVED_TAB.C5 AGG3, CASE WHEN TEST_DATA.C3=month_data.month_name THEN 'Y' ELSE 'N' END FLAG, month_data.month_name, DERIVED_TAB.derived_year FROM DERIVED_TAB JOIN TEST_DATA
ON DERIVED_TAB.derived_year = TEST_DATA.C5 
AND DERIVED_TAB.MONTH_NAME = TEST_DATA.C3
JOIN MONTH_DATA
ON MONTH_DATA.order_month = CASE WHEN DERIVED_TAB.ORDER_MON+1 = 13 THEN 1 Else DERIVED_TAB.ORDER_MON+1 end
--Order by DERIVED_TAB.C1, DERIVED_TAB.C3, DERIVED_TAB.C5
)
GROUP BY AGG2, AGG3, MONTH_NAME
